<script>
        // ================= 設定區 (請修改這裡) =================
        
        // 1. 您的 Google 問卷 "Base" 網址 (注意：不要包含 ? 後面的東西)
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfDJtEH3sZFseTSuwYf0VqOxasKRu-Pu_9jUdbTlK9hwt2CDQ/viewform";
        
        // 2. Google 表單欄位 ID (請填入您第一步查到的數字)
        const FORM_FIELDS = {
            LAT: "entry.1647830097",   // 填入 "緯度" 的 ID
            LON: "entry.492334172",   // 填入 "經度" 的 ID
            STATUS: "entry.1139328085" // 填入 "驗證結果" 的 ID
        };

        // 3. 目標地點經緯度
        const TARGET_LAT = 24.072195165135017;
        const TARGET_LON = 120.55587141858645;
        const ALLOWED_RADIUS = 20; // 公尺
        
        // ======================================================

        window.onload = startLocationCheck;

        function startLocationCheck() {
            // (這部分的代碼與上一版相同，省略以節省篇幅...)
            const msgDiv = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            btn.style.display = "none";
            msgDiv.innerHTML = "正在讀取您的 GPS 座標...";
            msgDiv.className = "status";

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "您的瀏覽器不支援定位功能。";
                return;
            }
            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        function success(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const msgDiv = document.getElementById("message");

            // 計算距離
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000;

            if (distance <= ALLOWED_RADIUS) {
                msgDiv.innerHTML = "✅ 驗證成功！正在寫入位置資訊並跳轉...";
                msgDiv.className = "status success";
                
                // --- 這裡是最新的修改 ---
                
                // 1. 準備要填入的參數
                const params = new URLSearchParams();
                params.append("usp", "pp_url"); // Google Form 固定參數
                params.append(FORM_FIELDS.LAT, userLat.toFixed(6)); // 填入緯度 (取小數6位)
                params.append(FORM_FIELDS.LON, userLon.toFixed(6)); // 填入經度
                params.append(FORM_FIELDS.STATUS, "驗證通過 (距離: " + Math.round(distance) + "m)"); // 填入狀態

                // 2. 組合最終網址
                const finalUrl = `${GOOGLE_FORM_BASE_URL}?${params.toString()}`;

                // 3. 跳轉
                setTimeout(() => {
                    window.location.replace(finalUrl);
                }, 1000);

            } else {
                // 驗證失敗時，通常不建議跳轉到問卷，直接擋在門外
                msgDiv.innerHTML = `❌ 驗證失敗。<br>您距離目標還有 ${Math.round(distance)} 公尺。<br>無法開啟問卷。`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";
            }
        }

        // (Error 函式與 Haversine 公式保持不變...)
        function error(err) { /* ...同上一版... */ 
             document.getElementById("message").innerHTML = "定位失敗";
             document.getElementById("retryBtn").style.display = "inline-block";
        }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { /* ...同上一版... */ 
             // 這裡請複製上一版的 Haversine 公式代碼
             var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
             var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
             var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
    </script>