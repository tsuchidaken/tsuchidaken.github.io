<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡é‚ç®±ç°½åˆ°</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; text-align: center; padding: 40px 20px; }
        .status { margin-top: 20px; font-size: 1.1em; color: #333; }
        .box-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; color: #0d47a1; border: 1px solid #90caf9;}
        .error { color: #d9534f; font-weight: bold; }
        .success { color: #5cb85c; font-weight: bold; }
        .loading { color: #ff9800; font-weight: bold; }
        button { padding: 10px 20px; font-size: 1rem; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“ å·¡é‚ç®±æ™ºæ…§ç°½åˆ°</h2>
    
    <div id="boxDisplay" class="box-info">æ­£åœ¨è®€å–å·¡é‚ç®±è³‡è¨Š...</div>
    <div id="message" class="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <button id="retryBtn" onclick="initSystem()" style="display:none;">é‡è©¦</button>

    <script>
        // ================= è¨­å®šå€ =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxm_4i3st34vhG4uWoSYTdgjKSTT5G1TCRrFI7Twbs9vMncHVulXy4ISVe_3uY1pxR2/exec";
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfDJtEH3sZFseTSuwYf0VqOxasKRu-Pu_9jUdbTlK9hwt2CDQ/viewform";
        
        const FORM_FIELDS = {
            LAT: "entry.1647830097",      
            LON: "entry.492334172",      
            STATUS: "entry.1139328085",   
            BOX_ID: "entry.865685784"   
        };

        const ALLOWED_RADIUS = 20; // å…è¨±èª¤å·® (å…¬å°º)
        // =========================================

        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†å­˜å¾ Sheet æŠ“ä¸‹ä¾†çš„ç›®æ¨™åº§æ¨™
        let TARGET_LAT = 0;
        let TARGET_LON = 0;
        let BOX_NAME = "";
        
        // å–å¾—ç¶²å€ä¸Šçš„ box_id
        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_BOX_ID = urlParams.get('box_id');

        window.onload = initSystem;

        // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–ç³»çµ±ï¼Œå»å¾Œç«¯æŠ“åº§æ¨™
        function initSystem() {
            const display = document.getElementById("boxDisplay");
            const msg = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            
            btn.style.display = "none";

            if (!CURRENT_BOX_ID) {
                display.innerHTML = "âŒ éŒ¯èª¤ï¼šç¶²å€æœªåŒ…å« box_id";
                msg.innerHTML = "è«‹æƒææ­£ç¢ºçš„ NFC æ¨™ç±¤ã€‚";
                msg.className = "status error";
                return;
            }

            display.innerHTML = `æ­£åœ¨æŸ¥è©¢å·¡é‚ç®±è³‡æ–™ (${CURRENT_BOX_ID})...`;
            msg.innerHTML = '<span class="loading">é€£ç·šè³‡æ–™åº«ä¸­...</span>';

            // å‘¼å« GAS çš„ doGet æŸ¥è©¢åº§æ¨™
            fetch(`${GAS_API_URL}?box_id=${CURRENT_BOX_ID}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // æˆåŠŸæŠ“åˆ°åº§æ¨™
                    TARGET_LAT = Number(data.lat);
                    TARGET_LON = Number(data.lon);
                    BOX_NAME = data.name || "æœªå‘½ååœ°é»";
                    
                    display.innerHTML = `ğŸ“¦ åœ°é»ï¼š${BOX_NAME} (${CURRENT_BOX_ID})`;
                    // é–‹å§‹é€²è¡Œ GPS å®šä½
                    startLocationCheck();
                } else {
                    // ID ä¸å­˜åœ¨
                    display.innerHTML = `âŒ ç„¡æ•ˆçš„ç®±è™Ÿï¼š${CURRENT_BOX_ID}`;
                    msg.innerHTML = "è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°æ­¤ IDï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
                    msg.className = "status error";
                }
            })
            .catch(err => {
                console.error(err);
                display.innerHTML = "âš ï¸ é€£ç·šéŒ¯èª¤";
                msg.innerHTML = "ç„¡æ³•é€£æ¥è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                btn.style.display = "inline-block";
            });
        }

        // ç¬¬äºŒæ­¥ï¼šé–‹å§‹å®šä½
        function startLocationCheck() {
            const msgDiv = document.getElementById("message");
            msgDiv.innerHTML = "è³‡æ–™å·²åŒæ­¥ï¼Œæ­£åœ¨è®€å–æ‚¨çš„ GPS...";
            msgDiv.className = "status";

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚";
                sendLogToSheet(0, 0, "Fail", "ç€è¦½å™¨ä¸æ”¯æ´");
                return;
            }

            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        // ç¬¬ä¸‰æ­¥ï¼šæ¯”å°ä¸¦è™•ç†çµæœ
        function success(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const msgDiv = document.getElementById("message");

            // ä½¿ç”¨å‹•æ…‹æŠ“å–åˆ°çš„ TARGET_LAT æ¯”å°
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000;
            const distInt = Math.round(distance);

            if (distance <= ALLOWED_RADIUS) {
                msgDiv.innerHTML = "âœ… é©—è­‰æˆåŠŸï¼æ­£åœ¨ç°½åˆ°...";
                msgDiv.className = "status success";

                sendLogToSheet(userLat, userLon, "Success", `åœ°é»:${BOX_NAME} / è·é›¢:${distInt}m`);

                const params = new URLSearchParams();
                params.append("usp", "pp_url");
                params.append(FORM_FIELDS.LAT, userLat.toFixed(6));
                params.append(FORM_FIELDS.LON, userLon.toFixed(6));
                params.append(FORM_FIELDS.STATUS, `é©—è­‰é€šé è½å·®è·é›¢ç´„: (${distInt}m)`);
                params.append(FORM_FIELDS.BOX_ID, CURRENT_BOX_ID);
                
                setTimeout(() => {
                    window.location.replace(`${GOOGLE_FORM_BASE_URL}?${params.toString()}`);
                }, 1500);

            } else {
                msgDiv.innerHTML = `âŒ ä½ç½®ä¸ç¬¦ã€‚<br>æ‚¨åœ¨ã€Œ${BOX_NAME}ã€çš„ç¯„åœå¤– (å·® ${distInt} å…¬å°º)ã€‚`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";

                sendLogToSheet(userLat, userLon, "Fail", `åœ°é»:${BOX_NAME} / è·é›¢éé :${distInt}m`);
            }
        }

        function error(err) {
            const msgDiv = document.getElementById("message");
            msgDiv.innerHTML = "GPS å®šä½å¤±æ•—ï¼Œè«‹ç¢ºä¿åœ¨æˆ¶å¤–ä¸¦é–‹å•Ÿæ¬Šé™ã€‚";
            msgDiv.className = "status error";
            document.getElementById("retryBtn").style.display = "inline-block";
            sendLogToSheet(0, 0, "Error", `GPS Error / åœ°é»:${BOX_NAME}`);
        }

        // å‚³é€ Log (POST)
        function sendLogToSheet(lat, lon, status, note) {
            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon, status: status, note: note })
            });
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
    </script>
</body>
</html>