<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®é©—è­‰</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; text-align: center; padding: 40px 20px; }
        .status { margin-top: 20px; font-size: 1.1em; color: #333; line-height: 1.6; }
        .error { color: #d9534f; font-weight: bold; }
        .success { color: #5cb85c; font-weight: bold; }
        button { padding: 10px 20px; font-size: 1rem; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“ ç¾å ´ç°½åˆ°é©—è­‰</h2>
    <div id="message" class="status">è«‹å…è¨±å®šä½æ¬Šé™ä»¥é€²è¡Œé©—è­‰...</div>
    <button id="retryBtn" onclick="startLocationCheck()" style="display:none;">é‡æ–°å®šä½</button>

    <script>
        // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
        
        // 1. æ‚¨çš„ Google å•å·ç¶²å€
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/æ‚¨çš„ID/viewform";
        
        // 2. ç›®æ¨™åœ°é»ç¶“ç·¯åº¦ (ç¯„ä¾‹ï¼šå°åŒ—101)
        const TARGET_LAT = 25.033964;
        const TARGET_LON = 121.564468;

        // 3. å…è¨±èª¤å·®ç¯„åœ (å…¬å°º)
        const ALLOWED_RADIUS = 50; 
        
        // ======================================================

        window.onload = startLocationCheck;

        function startLocationCheck() {
            const msgDiv = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            
            btn.style.display = "none";
            msgDiv.innerHTML = "æ­£åœ¨è®€å–æ‚¨çš„ GPS åº§æ¨™...";
            msgDiv.className = "status";

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚";
                return;
            }

            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true, // è¦æ±‚é«˜ç²¾ç¢ºåº¦
                timeout: 10000,           // ç­‰å¾… 10 ç§’
                maximumAge: 0             // ä¸ä½¿ç”¨å¿«å–
            });
        }

        function success(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const msgDiv = document.getElementById("message");

            // è¨ˆç®—è·é›¢
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000; // è½‰æˆå…¬å°º

            if (distance <= ALLOWED_RADIUS) {
                msgDiv.innerHTML = "âœ… é©—è­‰æˆåŠŸï¼æ­£åœ¨è·³è½‰è‡³å•å·...";
                msgDiv.className = "status success";
                
                setTimeout(() => {
                    window.location.replace(GOOGLE_FORM_URL); // ä½¿ç”¨ replace é¿å…ä½¿ç”¨è€…æŒ‰ä¸Šä¸€é å›ä¾†
                }, 1500);
            } else {
                msgDiv.innerHTML = `âŒ é©—è­‰å¤±æ•—ã€‚<br>æ‚¨è·é›¢ç›®æ¨™åœ°é»é‚„æœ‰ ${Math.round(distance)} å…¬å°ºã€‚<br>è«‹ç§»å‹•åˆ°ç¾å ´å¾Œå†è©¦ã€‚`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";
            }
        }

        function error(err) {
            const msgDiv = document.getElementById("message");
            msgDiv.className = "status error";
            let errorText = "ç„¡æ³•å–å¾—ä½ç½®ã€‚";
            
            if (err.code === 1) errorText = "æ‚¨æ‹’çµ•äº†å®šä½æ¬Šé™ã€‚<br>è«‹è‡³æ‰‹æ©Ÿè¨­å®šé–‹å•Ÿæ¬Šé™ã€‚";
            else if (err.code === 2) errorText = "GPS è¨Šè™Ÿä¸è‰¯ï¼Œè«‹èµ°åˆ°æˆ¶å¤–ç©ºæ› è™•ã€‚";
            else if (err.code === 3) errorText = "å®šä½é€¾æ™‚ï¼Œè«‹é‡è©¦ã€‚";

            msgDiv.innerHTML = errorText;
            document.getElementById("retryBtn").style.display = "inline-block";
        }

        // Haversine å…¬å¼ (JavaScript ç‰ˆ)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2-lat1);  // deg2rad below
            var dLon = deg2rad(lon2-lon1); 
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }
    </script>
</body>
</html>