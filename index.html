<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®é©—è­‰</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; text-align: center; padding: 40px 20px; }
        .status { margin-top: 20px; font-size: 1.1em; color: #333; line-height: 1.6; }
        .error { color: #d9534f; font-weight: bold; }
        .success { color: #5cb85c; font-weight: bold; }
        button { padding: 10px 20px; font-size: 1rem; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“ ç¾å ´ç°½åˆ°é©—è­‰</h2>
    <div id="message" class="status">è«‹å…è¨±å®šä½æ¬Šé™ä»¥é€²è¡Œé©—è­‰...</div>
    <button id="retryBtn" onclick="startLocationCheck()" style="display:none;">é‡æ–°å®šä½</button>

	<script>
        // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
        
        // 1. æ‚¨çš„ Google å•å· "Base" ç¶²å€ (æ³¨æ„ï¼šä¸è¦åŒ…å« ? å¾Œé¢çš„æ±è¥¿)
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfDJtEH3sZFseTSuwYf0VqOxasKRu-Pu_9jUdbTlK9hwt2CDQ/viewform";
        
        // 2. Google è¡¨å–®æ¬„ä½ ID (è«‹å¡«å…¥æ‚¨ç¬¬ä¸€æ­¥æŸ¥åˆ°çš„æ•¸å­—)
        const FORM_FIELDS = {
			NUM: "entry.865685784", // å·¡é‚ç®±è™Ÿç¢¼ ID
            LAT: "entry.1647830097",   // å¡«å…¥ "ç·¯åº¦" çš„ ID
            LON: "entry.492334172",   // å¡«å…¥ "ç¶“åº¦" çš„ ID
            STATUS: "entry.1139328085" // å¡«å…¥ "é©—è­‰çµæœ" çš„ ID
        };

        // 3. ç›®æ¨™åœ°é»ç¶“ç·¯åº¦
        const TARGET_LAT = 24.072195165135017;
        const TARGET_LON = 120.55587141858645;
        const ALLOWED_RADIUS = 20; // å…¬å°º
        
        // ======================================================

        window.onload = startLocationCheck;

        function startLocationCheck() {
            // (é€™éƒ¨åˆ†çš„ä»£ç¢¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…...)
            const msgDiv = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            btn.style.display = "none";
            msgDiv.innerHTML = "æ­£åœ¨è®€å–æ‚¨çš„ GPS åº§æ¨™...";
            msgDiv.className = "status";

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚";
                return;
            }
            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        function success(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const msgDiv = document.getElementById("message");

            // è¨ˆç®—è·é›¢
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000;

            if (distance <= ALLOWED_RADIUS) {
                msgDiv.innerHTML = "âœ… é©—è­‰æˆåŠŸï¼æ­£åœ¨å¯«å…¥ä½ç½®è³‡è¨Šä¸¦è·³è½‰...";
                msgDiv.className = "status success";
                
                // --- é€™è£¡æ˜¯æœ€æ–°çš„ä¿®æ”¹ ---
                
                // 1. æº–å‚™è¦å¡«å…¥çš„åƒæ•¸
                const params = new URLSearchParams();
                params.append("usp", "pp_url"); // Google Form å›ºå®šåƒæ•¸
				params.append(FORM_FIELDS.NUM,"1"); //å·¡é‚ç®±1è™Ÿ
                params.append(FORM_FIELDS.LAT, userLat.toFixed(6)); // å¡«å…¥ç·¯åº¦ (å–å°æ•¸6ä½)
                params.append(FORM_FIELDS.LON, userLon.toFixed(6)); // å¡«å…¥ç¶“åº¦
                params.append(FORM_FIELDS.STATUS, "é©—è­‰é€šé (è·é›¢: " + Math.round(distance) + "m)"); // å¡«å…¥ç‹€æ…‹

                // 2. çµ„åˆæœ€çµ‚ç¶²å€
                const finalUrl = `${GOOGLE_FORM_BASE_URL}?${params.toString()}`;

                // 3. è·³è½‰
                setTimeout(() => {
                    window.location.replace(finalUrl);
                }, 1000);

            } else {
                // é©—è­‰å¤±æ•—æ™‚ï¼Œé€šå¸¸ä¸å»ºè­°è·³è½‰åˆ°å•å·ï¼Œç›´æ¥æ“‹åœ¨é–€å¤–
                msgDiv.innerHTML = `âŒ é©—è­‰å¤±æ•—ã€‚<br>æ‚¨è·é›¢ç›®æ¨™é‚„æœ‰ ${Math.round(distance)} å…¬å°ºã€‚<br>ç„¡æ³•é–‹å•Ÿå•å·ã€‚`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";
            }
        }

        // (Error å‡½å¼èˆ‡ Haversine å…¬å¼ä¿æŒä¸è®Š...)
        function error(err) { /* ...åŒä¸Šä¸€ç‰ˆ... */ 
             document.getElementById("message").innerHTML = "å®šä½å¤±æ•—";
             document.getElementById("retryBtn").style.display = "inline-block";
        }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { /* ...åŒä¸Šä¸€ç‰ˆ... */ 
             // é€™è£¡è«‹è¤‡è£½ä¸Šä¸€ç‰ˆçš„ Haversine å…¬å¼ä»£ç¢¼
             var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
             var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
             var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
    </script>
</body>
</html>