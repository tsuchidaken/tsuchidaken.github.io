<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡é‚ç®±ç°½åˆ°</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            text-align: center;
            padding: 40px 20px;
        }

        .status {
            margin-top: 20px;
            font-size: 1.1em;
            color: #333;
            line-height: 1.6;
        }

        .box-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #0d47a1;
            border: 1px solid #90caf9;
        }

        .error {
            color: #d9534f;
            font-weight: bold;
        }

        .success {
            color: #5cb85c;
            font-weight: bold;
        }

        .loading {
            color: #ff9800;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            margin-top: 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <h2>ğŸ“ å·¡é‚ç®±æ™ºæ…§ç°½åˆ°</h2>

    <div id="boxDisplay" class="box-info">æ­£åœ¨è®€å–å·¡é‚ç®±è³‡è¨Š...</div>
    <div id="message" class="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <button id="retryBtn" onclick="initSystem()" style="display:none;">é‡è©¦</button>

    <script>
        // ================= è¨­å®šå€ =================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxm_4i3st34vhG4uWoSYTdgjKSTT5G1TCRrFI7Twbs9vMncHVulXy4ISVe_3uY1pxR2/exec";
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfDJtEH3sZFseTSuwYf0VqOxasKRu-Pu_9jUdbTlK9hwt2CDQ/viewform";

        const FORM_FIELDS = {
            STATUS: "entry.1139328085",
            BOX_ID: "entry.865685784",
            TOKEN: "entry.1647830097" // â˜…è¨˜å¾—ç¢ºèªé€™æ˜¯æ‚¨è¡¨å–®ã€Œé©—è­‰ç¢¼ã€çš„ ID
        };

        const ALLOWED_RADIUS = 20;
        const REQUIRED_ACCURACY = 25;
        const MAX_WAIT_TIME = 10000;
        // =========================================

        let TARGET_LAT = 0;
        let TARGET_LON = 0;
        let BOX_NAME = "";

        let watchId = null;
        let bestPosition = null;
        let timeoutTimer = null;

        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_BOX_ID = urlParams.get('box_id');

        window.onload = initSystem;

        function initSystem() {
            const display = document.getElementById("boxDisplay");
            const msg = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            btn.style.display = "none";

            if (!CURRENT_BOX_ID) {
                display.innerHTML = "âŒ éŒ¯èª¤ï¼šç¶²å€æœªåŒ…å« box_id";
                msg.innerHTML = "è«‹æƒææ­£ç¢ºçš„ NFC æ¨™ç±¤ã€‚";
                msg.className = "status error";
                return;
            }

            display.innerHTML = `æ­£åœ¨æŸ¥è©¢è³‡æ–™ (${CURRENT_BOX_ID})...`;
            msg.innerHTML = '<span class="loading">é€£ç·šè³‡æ–™åº«ä¸­...</span>';

            fetch(`${GAS_API_URL}?box_id=${CURRENT_BOX_ID}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        TARGET_LAT = Number(data.lat);
                        TARGET_LON = Number(data.lon);
                        BOX_NAME = data.name || "æœªå‘½ååœ°é»";
                        display.innerHTML = `ğŸ“¦ åœ°é»ï¼š${BOX_NAME}`;
                        startSmartLocationCheck();
                    } else {
                        display.innerHTML = `âŒ ç„¡æ•ˆçš„ç®±è™Ÿ`;
                        msg.innerHTML = "è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°æ­¤ IDã€‚";
                        msg.className = "status error";
                    }
                })
                .catch(err => {
                    console.error(err);
                    display.innerHTML = "âš ï¸ é€£ç·šéŒ¯èª¤";
                    btn.style.display = "inline-block";
                });
        }

        function startSmartLocationCheck() {
            const msgDiv = document.getElementById("message");
            msgDiv.className = "status";
            msgDiv.innerHTML = "ğŸ“¡ æ­£åœ¨ç²¾æº–å®šä½ä¸­...<br>(è«‹ä¿æŒåœ¨æˆ¶å¤–ï¼Œä¸¦é–‹å•Ÿ Wi-Fi è¼”åŠ©)";

            bestPosition = null;

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚";
                return;
            }

            timeoutTimer = setTimeout(() => {
                finishLocationCheck("timeout");
            }, MAX_WAIT_TIME);

            watchId = navigator.geolocation.watchPosition(
                processPosition,
                handleError,
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function processPosition(position) {
            const currentAcc = position.coords.accuracy;
            const msgDiv = document.getElementById("message");
            msgDiv.innerHTML = `å®šä½ä¸­...<br>èª¤å·®ï¼š${Math.round(currentAcc)}m (ç›®æ¨™ < ${REQUIRED_ACCURACY}m)`;

            if (!bestPosition || currentAcc < bestPosition.coords.accuracy) {
                bestPosition = position;
            }
            if (currentAcc <= REQUIRED_ACCURACY) {
                finishLocationCheck("success");
            }
        }

        function finishLocationCheck(reason) {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            if (timeoutTimer !== null) clearTimeout(timeoutTimer);
            watchId = null;

            const msgDiv = document.getElementById("message");

            if (!bestPosition) {
                handleError({ code: 3, message: "Timeout" });
                return;
            }

            const userLat = bestPosition.coords.latitude;
            const userLon = bestPosition.coords.longitude;
            const accuracy = bestPosition.coords.accuracy;
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000;
            const distInt = Math.round(distance);

            // â˜… ç”¢ç”Ÿäº‚ç¢¼ Token
            const securityToken = generateToken(20);

            if (distance <= ALLOWED_RADIUS) {
                // === é©—è­‰æˆåŠŸ ===
                msgDiv.innerHTML = `âœ… é©—è­‰æˆåŠŸï¼<br>è·é›¢ï¼š${distInt}m<br>æ­£åœ¨ç”¢ç”Ÿé©—è­‰ç¢¼...`;
                msgDiv.className = "status success";

                // â˜… ä¿®æ”¹é» 1: å‚³é€ Log (åŒ…å«ç¨ç«‹çš„ Token)
                // Note æ¬„ä½ç¾åœ¨åªæ”¾åœ°é»å’Œè·é›¢ï¼Œä¸å†åŒ…å« Token
                sendLogToSheet(userLat, userLon, "Success", `åœ°é»:${BOX_NAME} / è·é›¢:${distInt}m`, securityToken);

                // æº–å‚™è·³è½‰
                const params = new URLSearchParams();
                params.append("usp", "pp_url");
                params.append(FORM_FIELDS.STATUS, `é©—è­‰é€šé (è·é›¢:${distInt}m)`);
                params.append(FORM_FIELDS.BOX_ID, CURRENT_BOX_ID);
                params.append(FORM_FIELDS.TOKEN, securityToken); // é å¡« Token

                setTimeout(() => {
                    window.location.replace(`${GOOGLE_FORM_BASE_URL}?${params.toString()}`);
                }, 1500);

            } else {
                // === é©—è­‰å¤±æ•— ===
                msgDiv.innerHTML = `âŒ ä½ç½®ä¸ç¬¦ã€‚<br>æ‚¨åœ¨ã€Œ${BOX_NAME}ã€ç¯„åœå¤– (å·® ${distInt}m)ã€‚`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";

                // â˜… ä¿®æ”¹é» 2: å¤±æ•—æ™‚ã€Œä¸ã€å‘¼å« sendLogToSheet
                // é€™è£¡ç•™ç©ºï¼Œæˆ–è€…æ‚¨å¯ä»¥åªåœ¨ console.log è¨˜éŒ„æ–¹ä¾¿é™¤éŒ¯
                console.log("é©—è­‰å¤±æ•—ï¼Œä¸å¯«å…¥ Logã€‚è·é›¢:", distInt);
            }
        }

        function handleError(err) {
            const msgDiv = document.getElementById("message");
            msgDiv.innerHTML = "GPS å®šä½å¤±æ•—ï¼Œè«‹ç¢ºä¿åœ¨æˆ¶å¤–ä¸¦é–‹å•Ÿæ¬Šé™ã€‚";
            msgDiv.className = "status error";
            document.getElementById("retryBtn").style.display = "inline-block";
            // å®šä½å¤±æ•—ä¹Ÿä¸å¯«å…¥ Log
        }

        // â˜… ä¿®æ”¹é» 3: æ¥æ”¶ Token ä¸¦å‚³é€åˆ°å¾Œç«¯
        function sendLogToSheet(lat, lon, status, note, token) {
            fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    status: status,
                    note: note,    // åŸæœ¬çš„å‚™è¨» (ä¸å« Token)
                    token: token   // ç¨ç«‹çš„ Token æ¬„ä½
                })
            }).catch(err => console.error(err));
        }

        function generateToken(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180) }
    </script>
</body>

</html>