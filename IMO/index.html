<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡é‚ç®±ç°½åˆ°</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; text-align: center; padding: 40px 20px; }
        .status { margin-top: 20px; font-size: 1.1em; color: #333; }
        .box-info { background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 15px 0; font-weight: bold; color: #0056b3; }
        .error { color: #d9534f; font-weight: bold; }
        .success { color: #5cb85c; font-weight: bold; }
        button { padding: 10px 20px; font-size: 1rem; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“ å·¡é‚ç®±ç°½åˆ°ç³»çµ±</h2>
    
    <div id="boxDisplay" class="box-info">æ­£åœ¨è®€å–å·¡é‚ç®±è³‡è¨Š...</div>
    
    <div id="message" class="status">è«‹å…è¨±å®šä½æ¬Šé™ä»¥é€²è¡Œé©—è­‰...</div>
    <button id="retryBtn" onclick="startLocationCheck()" style="display:none;">é‡æ–°å®šä½</button>

    <script>
        // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
        
        // 1. Google Apps Script ç¶²å€ (Log ç´€éŒ„ç”¨)
        const LOG_API_URL = "https://script.google.com/macros/s/AKfycbxm_4i3st34vhG4uWoSYTdgjKSTT5G1TCRrFI7Twbs9vMncHVulXy4ISVe_3uY1pxR2/exec";

        // 2. Google å•å·è¨­å®š
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfDJtEH3sZFseTSuwYf0VqOxasKRu-Pu_9jUdbTlK9hwt2CDQ/viewform";
        const FORM_FIELDS = {
            LAT: "entry.1647830097",      // ç·¯åº¦ ID
            LON: "entry.492334172",      // ç¶“åº¦ ID
            STATUS: "entry.1139328085",   // é©—è­‰çµæœ ID
            BOX_ID: "entry.865685784"   // â˜… æ–°å¢ï¼šå·¡é‚ç®± ID
        };

        // 3. åœ°é»è¨­å®š
        const TARGET_LAT = 24.072195165135017;
        const TARGET_LON = 120.55587141858645;
        const ALLOWED_RADIUS = 20; 
        
        // ======================================================

        // â˜… æ–°å¢ï¼šå¾ç¶²å€å–å¾—å·¡é‚ç®± ID
        const urlParams = new URLSearchParams(window.location.search);
        // å¦‚æœç¶²å€æ˜¯ ?box_id=A01ï¼Œé€™è£¡å°±æœƒæŠ“åˆ° "A01"
        const CURRENT_BOX_ID = urlParams.get('box_id') || "æœªæŒ‡å®š(Unknown)";

        window.onload = function() {
            // é¡¯ç¤ºç®±è™Ÿåœ¨ç•«é¢ä¸Š
            document.getElementById("boxDisplay").innerText = "ğŸ“¦ ç›®å‰å·¡é‚ç®±ï¼š " + CURRENT_BOX_ID;
            startLocationCheck();
        };

        function startLocationCheck() {
            const msgDiv = document.getElementById("message");
            const btn = document.getElementById("retryBtn");
            btn.style.display = "none";
            msgDiv.innerHTML = "æ­£åœ¨è®€å–åº§æ¨™...";
            msgDiv.className = "status";

            if (!navigator.geolocation) {
                msgDiv.innerHTML = "ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚";
                sendLogToSheet(0, 0, "Fail", "ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
                return;
            }

            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        function success(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const msgDiv = document.getElementById("message");

            // è¨ˆç®—è·é›¢
            const distance = getDistanceFromLatLonInKm(userLat, userLon, TARGET_LAT, TARGET_LON) * 1000;
            const distInt = Math.round(distance);

            if (distance <= ALLOWED_RADIUS) {
                msgDiv.innerHTML = "âœ… é©—è­‰æˆåŠŸï¼æ­£åœ¨ç°½åˆ°...";
                msgDiv.className = "status success";

                // 1. èƒŒæ™¯å‚³é€ Log (åŒ…å«ç®±è™Ÿ)
                sendLogToSheet(userLat, userLon, "Success", `ç®±è™Ÿ:${CURRENT_BOX_ID} / è·é›¢:${distInt}m`);

                // 2. æº–å‚™å•å·è·³è½‰ (åŒ…å«ç®±è™Ÿ)
                const params = new URLSearchParams();
                params.append("usp", "pp_url");
                params.append(FORM_FIELDS.LAT, userLat.toFixed(6));
                params.append(FORM_FIELDS.LON, userLon.toFixed(6));
                params.append(FORM_FIELDS.STATUS, `é©—è­‰é€šé è·é›¢ç´„: (${distInt}m)`);
                params.append(FORM_FIELDS.BOX_ID, CURRENT_BOX_ID); // â˜… å¡«å…¥ç®±è™Ÿ
                
                setTimeout(() => {
                    window.location.replace(`${GOOGLE_FORM_BASE_URL}?${params.toString()}`);
                }, 1500);

            } else {
                msgDiv.innerHTML = `âŒ é©—è­‰å¤±æ•—ã€‚<br>è·é›¢ç›®æ¨™é‚„æœ‰ ${distInt} å…¬å°ºã€‚<br>è«‹ç§»å‹•è‡³å·¡é‚é»ç¯„åœå…§ã€‚`;
                msgDiv.className = "status error";
                document.getElementById("retryBtn").style.display = "inline-block";

                // è¨˜éŒ„å¤±æ•— Log
                sendLogToSheet(userLat, userLon, "Fail", `ç®±è™Ÿ:${CURRENT_BOX_ID} / è·é›¢éé :${distInt}m`);
            }
        }

        function error(err) {
            const msgDiv = document.getElementById("message");
            msgDiv.className = "status error";
            let note = "æœªçŸ¥éŒ¯èª¤";
            if (err.code === 1) note = "æ‹’çµ•æ¬Šé™";
            else if (err.code === 2) note = "è¨Šè™Ÿä¸è‰¯";
            else if (err.code === 3) note = "é€¾æ™‚";

            msgDiv.innerHTML = `å®šä½å¤±æ•— (${note})`;
            document.getElementById("retryBtn").style.display = "inline-block";

            sendLogToSheet(0, 0, "Error", `ç®±è™Ÿ:${CURRENT_BOX_ID} / ${note}`);
        }

        function sendLogToSheet(lat, lon, status, note) {
            if (LOG_API_URL.includes("æ‚¨çš„GAS_ID")) return; 
            
            fetch(LOG_API_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    status: status,
                    note: note // ç®±è™Ÿè³‡è¨Šå·²ç¶“åˆä½µåœ¨é€™å€‹å‚™è¨»æ¬„ä½è£¡å‚³é€
                })
            }).catch(err => console.error("Log failed:", err));
        }

        // Haversine å…¬å¼ (ä¿æŒä¸è®Š)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
    </script>
</body>
</html>